-- version ms sql ojo 

-- ===========================================
-- CREAR BASE DE DATOS SI NO EXISTE
-- ===========================================
IF DB_ID('UPEGaming') IS NULL
    CREATE DATABASE UPEGaming;
GO

USE UPEGaming;
GO

-- ===========================================
-- ELIMINAR TABLAS SI EXISTEN (en orden inverso a dependencias)
-- ===========================================
IF OBJECT_ID('JUEGO_IMAGEN', 'U') IS NOT NULL DROP TABLE JUEGO_IMAGEN;
IF OBJECT_ID('FAQ', 'U') IS NOT NULL DROP TABLE FAQ;
IF OBJECT_ID('REPORTE_COMENTARIO', 'U') IS NOT NULL DROP TABLE REPORTE_COMENTARIO;
IF OBJECT_ID('COMENTARIO', 'U') IS NOT NULL DROP TABLE COMENTARIO;
IF OBJECT_ID('CALIFICACION', 'U') IS NOT NULL DROP TABLE CALIFICACION;
IF OBJECT_ID('FAVORITO', 'U') IS NOT NULL DROP TABLE FAVORITO;
IF OBJECT_ID('JUEGO_PLATAFORMA', 'U') IS NOT NULL DROP TABLE JUEGO_PLATAFORMA;
IF OBJECT_ID('JUEGO_GENERO', 'U') IS NOT NULL DROP TABLE JUEGO_GENERO;
IF OBJECT_ID('JUEGO', 'U') IS NOT NULL DROP TABLE JUEGO;
IF OBJECT_ID('GENERO', 'U') IS NOT NULL DROP TABLE GENERO;
IF OBJECT_ID('PLATAFORMA', 'U') IS NOT NULL DROP TABLE PLATAFORMA;
IF OBJECT_ID('EMPRESA', 'U') IS NOT NULL DROP TABLE EMPRESA;
IF OBJECT_ID('ROL_PERMISO', 'U') IS NOT NULL DROP TABLE ROL_PERMISO;
IF OBJECT_ID('PERMISO', 'U') IS NOT NULL DROP TABLE PERMISO;
IF OBJECT_ID('USUARIO', 'U') IS NOT NULL DROP TABLE USUARIO;
IF OBJECT_ID('ROL', 'U') IS NOT NULL DROP TABLE ROL;
GO

-- ===========================================
-- CREACIÃ“N DE TABLAS
-- ===========================================

CREATE TABLE ROL (
  id_rol INT IDENTITY(1,1) PRIMARY KEY,
  nombre VARCHAR(50) NOT NULL UNIQUE
);

CREATE TABLE PERMISO (
  id_permiso INT IDENTITY(1,1) PRIMARY KEY,
  nombre VARCHAR(100) NOT NULL UNIQUE,
  descripcion VARCHAR(255)
);

CREATE TABLE ROL_PERMISO (
  id_rol INT NOT NULL,
  id_permiso INT NOT NULL,
  PRIMARY KEY (id_rol, id_permiso),
  FOREIGN KEY (id_rol) REFERENCES ROL(id_rol) ON DELETE CASCADE,
  FOREIGN KEY (id_permiso) REFERENCES PERMISO(id_permiso) ON DELETE CASCADE
);

CREATE TABLE USUARIO (
  id_usuario INT IDENTITY(1,1) PRIMARY KEY,
  username VARCHAR(50) NOT NULL UNIQUE,
  email VARCHAR(100) NOT NULL UNIQUE,
  password_hash VARCHAR(255) NOT NULL,
  rol_id INT NOT NULL,
  avatar VARCHAR(255) NULL,
  fecha_registro DATETIME DEFAULT GETDATE(),
  estado VARCHAR(15) DEFAULT 'activo' CHECK (estado IN ('activo','restringido')),
  restriccion_hasta DATETIME NULL,
  FOREIGN KEY (rol_id) REFERENCES ROL(id_rol)
);

CREATE TABLE EMPRESA (
  id_empresa INT IDENTITY(1,1) PRIMARY KEY,
  nombre VARCHAR(100) NOT NULL,
  sitio_web VARCHAR(150)
);

CREATE TABLE PLATAFORMA (
  id_plataforma INT IDENTITY(1,1) PRIMARY KEY,
  nombre VARCHAR(100) NOT NULL UNIQUE
);

CREATE TABLE GENERO (
  id_genero INT IDENTITY(1,1) PRIMARY KEY,
  nombre VARCHAR(100) NOT NULL UNIQUE
);

CREATE TABLE JUEGO (
  id_juego INT IDENTITY(1,1) PRIMARY KEY,
  titulo VARCHAR(150) NOT NULL,
  descripcion VARCHAR(MAX),
  fecha_lanzamiento DATE,
  id_empresa INT NOT NULL,
  imagen_portada VARCHAR(255),
  FOREIGN KEY (id_empresa) REFERENCES EMPRESA(id_empresa)
);

CREATE TABLE JUEGO_GENERO (
  id_juego INT NOT NULL,
  id_genero INT NOT NULL,
  PRIMARY KEY (id_juego, id_genero),
  FOREIGN KEY (id_juego) REFERENCES JUEGO(id_juego) ON DELETE CASCADE,
  FOREIGN KEY (id_genero) REFERENCES GENERO(id_genero) ON DELETE CASCADE
);

CREATE TABLE JUEGO_PLATAFORMA (
  id_juego INT NOT NULL,
  id_plataforma INT NOT NULL,
  PRIMARY KEY (id_juego, id_plataforma),
  FOREIGN KEY (id_juego) REFERENCES JUEGO(id_juego) ON DELETE CASCADE,
  FOREIGN KEY (id_plataforma) REFERENCES PLATAFORMA(id_plataforma) ON DELETE CASCADE
);

CREATE TABLE FAVORITO (
  id_usuario INT NOT NULL,
  id_juego INT NOT NULL,
  fecha_agregado DATETIME DEFAULT GETDATE(),
  PRIMARY KEY (id_usuario, id_juego),
  FOREIGN KEY (id_usuario) REFERENCES USUARIO(id_usuario) ON DELETE CASCADE,
  FOREIGN KEY (id_juego) REFERENCES JUEGO(id_juego) ON DELETE CASCADE
);

CREATE TABLE CALIFICACION (
  id_usuario INT NOT NULL,
  id_juego INT NOT NULL,
  puntuacion TINYINT NOT NULL CHECK (puntuacion BETWEEN 0 AND 5),
  fecha DATETIME DEFAULT GETDATE(),
  PRIMARY KEY (id_usuario, id_juego),
  FOREIGN KEY (id_usuario) REFERENCES USUARIO(id_usuario) ON DELETE CASCADE,
  FOREIGN KEY (id_juego) REFERENCES JUEGO(id_juego) ON DELETE CASCADE
);

CREATE TABLE COMENTARIO (
  id_comentario INT IDENTITY(1,1) PRIMARY KEY,
  id_usuario INT NOT NULL,
  id_juego INT NOT NULL,
  contenido VARCHAR(MAX) NOT NULL,
  fecha DATETIME DEFAULT GETDATE(),
  estado VARCHAR(15) DEFAULT 'activo' CHECK (estado IN ('activo','reportado','eliminado')),
  FOREIGN KEY (id_usuario) REFERENCES USUARIO(id_usuario) ON DELETE CASCADE,
  FOREIGN KEY (id_juego) REFERENCES JUEGO(id_juego) ON DELETE CASCADE
);

CREATE TABLE REPORTE_COMENTARIO (
  id_reporte INT IDENTITY(1,1) PRIMARY KEY,
  id_comentario INT NOT NULL,
  id_usuario_reporta INT NOT NULL,
  motivo VARCHAR(255) NOT NULL,
  fecha_reporte DATETIME DEFAULT GETDATE(),
  id_moderador_accion INT NULL,
  fecha_accion DATETIME NULL,
  accion VARCHAR(15) NULL CHECK (accion IN ('ignorar','restringir')),
  observaciones VARCHAR(255) NULL,
  FOREIGN KEY (id_comentario) REFERENCES COMENTARIO(id_comentario) ON DELETE CASCADE,
  FOREIGN KEY (id_usuario_reporta) REFERENCES USUARIO(id_usuario),
  FOREIGN KEY (id_moderador_accion) REFERENCES USUARIO(id_usuario)
);

CREATE TABLE FAQ (
  id_faq INT IDENTITY(1,1) PRIMARY KEY,
  pregunta VARCHAR(255) NOT NULL,
  respuesta VARCHAR(MAX),
  visible BIT DEFAULT 1,
  id_autor INT NOT NULL,
  fecha_creacion DATETIME DEFAULT GETDATE(),
  FOREIGN KEY (id_autor) REFERENCES USUARIO(id_usuario)
);

CREATE TABLE JUEGO_IMAGEN (
  id_imagen INT IDENTITY(1,1) PRIMARY KEY,
  id_juego INT NOT NULL,
  url_imagen VARCHAR(255) NOT NULL,
  FOREIGN KEY (id_juego) REFERENCES JUEGO(id_juego) ON DELETE CASCADE
);
GO
